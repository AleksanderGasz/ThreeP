@namespace ThreeP.Modules.Items
@page "/equipment"
@inject ItemsService ItemsService
@inject SetService SetService
@inject ShowResultService ShowResultService
@attribute [Authorize]

<ItemUpdate Item="item" ItemChanged="UpdateItem"/>
<MudStack Row StretchItems="StretchItems.All" Justify="Justify.SpaceBetween">
    <ItemsGrid Items="Items" OnEdit="EditItem" OnDelete="DeleteItem" OnSetCreating="UpdateSet"/>
    <SetsGrid Sets="Sets" OnEdit="EditSet" OnDelete="DeleteSet"/>
</MudStack>

@code {
    [CascadingParameter] public AppState AppState { get; set; }
    [PersistentState] public List<Item>? Items { get; set; }
    [PersistentState] public List<Set>? Sets { get; set; } = [];
    Item? item;
    Guid? userId => AppState.UserId;


    protected override async Task OnInitializedAsync()
    {
        await GetItems();
        await GetSets();
    }


// ITEMS
    async Task GetItems() => Items = await ItemsService.Get([x => x.Sets], filters: [x => x.UserId ==userId]);


    async Task EditItem(Item arg) => item = arg;


    async Task UpdateItem(Item? arg)
    {
        item = arg;
        item.UserId=userId;
        var result = await ItemsService.UpsertItem(item);
        ShowResultService.ShowResultMessage(result);
        await GetItems();
    }


    async Task DeleteItem(Guid? id)
    {
        var result = await ItemsService.Delete(id);
        ShowResultService.ShowResultMessage(result);
        await GetItems();
    }


    // SETS
    async Task GetSets() => Sets = await SetService.Get([x => x.Items],[x=>x.UserId==userId]);


    async Task UpdateSet(Set? arg)
    {
        arg.UserId = userId;
        var result = await SetService.UpdateSet(arg);
        ShowResultService.ShowResultMessage(result);
        await GetSets();
    }


    async Task EditSet(Set? arg)
    {
        var result = await SetService.UpdateSet(arg);
        ShowResultService.ShowResultMessage(result);
        await GetSets();
    }


    async Task DeleteSet(Guid? id)
    {
        var result = await SetService.Delete(id);
        ShowResultService.ShowResultMessage(result);
        await GetSets();
    }
}